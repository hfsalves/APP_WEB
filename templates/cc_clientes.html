{% extends "base.html" %}

{% set page_title = "Contas Correntes - Clientes" %}
{% set page_name = "Contas Correntes - Clientes" %}

{% block title %}Contas Correntes - Clientes{% endblock %}

{% block content %}
<div class="container-fluid py-3 cc-page">
  <div class="d-flex flex-wrap align-items-center justify-content-end gap-2 mb-3">
    <button type="button" class="btn btn-outline-primary btn-sm" id="btnAssistRecebimentos">
      <i class="fa-solid fa-wand-magic-sparkles me-1"></i> Assistente de recebimentos
    </button>
    <div class="form-check form-switch mb-0">
      <input class="form-check-input" type="checkbox" id="ccPendentesOnly">
      <label class="form-check-label" for="ccPendentesOnly">Apenas pendentes</label>
    </div>
  </div>

  <div class="row g-3 mb-3 cc-top-row">
    <div class="col-md-6">
      <div class="card cc-card h-100">
        <div class="card-body">
          <div class="text-muted small">A receber total em aberto (j&aacute; com cr&eacute;ditos)</div>
          <div class="cc-kpi" id="ccTotalAberto">0</div>
          <div class="text-muted small">Clientes: <span id="ccCountClientes">0</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card cc-card h-100">
        <div class="card-body">
          <label class="text-muted small mb-1" for="ccSearch">Pesquisar cliente</label>
          <div class="input-group">
            <span class="input-group-text bg-light"><i class="fa fa-search"></i></span>
            <input type="text" class="form-control" id="ccSearch" placeholder="N&ordm; ou nome...">
          </div>
          <div class="text-muted small mt-2" id="ccStatus"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card cc-card cc-grid-card">
    <div class="card-body p-0 cc-grid-body">
      <div class="cc-table-wrap">
        <table class="table table-sm align-middle mb-0 cc-table" id="ccTable">
          <thead>
            <tr>
              <th class="cc-sortable" data-sort="NO" style="width:110px;">N&ordm;</th>
              <th class="cc-sortable" data-sort="NOME">Cliente</th>
              <th class="cc-sortable text-end" data-sort="SALDO_ABERTO" style="width:190px;">Em aberto</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="3" class="text-muted p-3">A carregar...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Assistente de Recebimentos -->
<div class="modal fade" id="recWizardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header cc-modal-header">
        <div class="w-100">
          <div class="d-flex flex-wrap justify-content-between align-items-end gap-2">
            <div>
              <h5 class="modal-title mb-0">Assistente de recebimentos</h5>
              <div class="small opacity-75">Selecione os pendentes a receber e confirme.</div>
            </div>
            <div class="d-flex align-items-end gap-3">
              <div>
                <div class="small opacity-75">Data</div>
                <input type="date" class="form-control form-control-sm" id="recDate">
              </div>
              <div class="text-end">
                <div class="small opacity-75">Selecionado</div>
                <div class="fw-bold" id="recSelectedTotal">0</div>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-6">
            <label class="form-label small mb-1" for="recSearch">Pesquisar</label>
            <div class="input-group">
              <span class="input-group-text bg-light"><i class="fa fa-search"></i></span>
              <input type="text" id="recSearch" class="form-control" placeholder="Cliente, documento, n.&ordm;...">
            </div>
          </div>
          <div class="col-md-6 text-md-end">
            <button type="button" class="btn btn-outline-secondary btn-sm" id="recSelectAll">Selecionar tudo</button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="recClearAll">Limpar</button>
          </div>
        </div>
        <div class="cc-modal-table-wrap" id="recTableWrap">
          <table class="table table-sm align-middle mb-0" id="recTable">
            <thead>
              <tr>
                <th style="width:44px;"></th>
                <th class="rec-sortable" data-sort="NO" style="width:90px;">No</th>
                <th class="rec-sortable" data-sort="NOME">Cliente</th>
                <th class="rec-sortable" data-sort="DATAVEN" style="width:140px;">Venc.</th>
                <th class="rec-sortable" data-sort="CMDESC" style="width:140px;">Doc.</th>
                <th class="rec-sortable" data-sort="NRDOC" style="width:120px;">N&ordm;</th>
                <th class="rec-sortable text-end" data-sort="ABERTO" style="width:140px;">Aberto</th>
                <th class="rec-sortable text-end" data-sort="RECVAL" style="width:160px;">A receber</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" class="text-muted p-3">A carregar...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="small text-muted mt-2" id="recStatus"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
        <button type="button" class="btn btn-primary" id="recConfirm">
          <i class="fa-solid fa-check me-1"></i> Confirmar recebimento
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* Layout: os cards ficam em cima; a grelha ocupa o resto (desktop) */
  .cc-page {
    display: flex;
    flex-direction: column;
    height: 100%;
    min-height: 0;
  }
  .cc-top-row {
    flex: 0 0 auto;
  }
  .cc-grid-card {
    flex: 1 1 auto;
    min-height: 0;
  }
  .cc-grid-body {
    height: 100%;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .cc-card {
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  }
  .cc-kpi {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: 0.01em;
    color: #0f172a;
    margin: 2px 0 6px 0;
  }

  /* Grelha moderna + scroll interno */
  .cc-table-wrap {
    flex: 1 1 auto;
    min-height: 0;
    overflow: auto;
    border-radius: 14px;
  }
  .cc-table {
    border-collapse: separate;
    border-spacing: 0 6px;
    width: 100%;
    min-width: 680px;
    font-size: 12px;
    color: #0f172a;
  }
  .cc-table thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 11px;
    color: #334155;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    border-bottom: 1px solid rgba(148, 163, 184, 0.35);
    padding: 0.55rem 0.75rem;
  }
  .cc-sortable {
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  .cc-sortable::after {
    content: "  \2195";
    opacity: 0.35;
    font-weight: 900;
  }
  .cc-sortable.sort-asc::after {
    content: "  \2191";
    opacity: 0.9;
  }
  .cc-sortable.sort-desc::after {
    content: "  \2193";
    opacity: 0.9;
  }
  .cc-table tbody tr {
    background: #fff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
    cursor: pointer;
  }
  .cc-table tbody tr td {
    border: none;
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
  }
  .cc-table tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight: 700;
    color: #0f172a;
  }
  .cc-table tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
  }
  .cc-table tbody tr:hover {
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
  }

  .cc-badge-neg {
    color: #991b1b;
    font-weight: 700;
  }
  .cc-badge-pos {
    color: #1f2937;
    font-weight: 800;
  }
  .cc-modal-header {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
    color: #fff;
    border-bottom: none;
  }
  .cc-modal-header .btn-close {
    filter: invert(1) grayscale(1) brightness(2);
    opacity: 0.9;
  }
  .cc-modal-table-wrap {
    max-height: 65vh;
    overflow: auto;
    border: 1px solid rgba(148, 163, 184, 0.35);
    border-radius: 12px;
    background: #fff;
  }
  #ccModalTable {
    border-collapse: separate;
    border-spacing: 0 6px;
    width: 100%;
    min-width: 980px;
    font-size: 12px;
    color: #0f172a;
  }
  #ccModalTable thead th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
    box-shadow: 0 1px 0 rgba(148, 163, 184, 0.45);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 11px;
    color: #334155;
    padding: 0.55rem 0.75rem;
    white-space: nowrap;
  }
  #ccModalTable tbody tr {
    background: #fff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
  }
  #ccModalTable tbody tr td {
    border: none;
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
  }
  #ccModalTable tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight: 700;
  }
  #ccModalTable tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
  }
  #ccModalTable tbody tr:hover {
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
  }

  /* Wizard recebimentos */
  #recTable {
    border-collapse: separate;
    border-spacing: 0 6px;
    width: 100%;
    min-width: 980px;
    font-size: 12px;
    color: #0f172a;
  }
  #recTable thead th {
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 2;
    box-shadow: 0 1px 0 rgba(148, 163, 184, 0.45);
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 11px;
    color: #334155;
    padding: 0.55rem 0.75rem;
    white-space: nowrap;
  }
  #recTable thead th.rec-sortable {
    cursor: pointer;
    user-select: none;
  }
  #recTable thead th.rec-sortable::after {
    content: "  \2195";
    opacity: 0.35;
    font-weight: 900;
  }
  #recTable thead th.rec-sortable.sort-asc::after {
    content: "  \2191";
    opacity: 0.9;
  }
  #recTable thead th.rec-sortable.sort-desc::after {
    content: "  \2193";
    opacity: 0.9;
  }
  #recTable tbody tr {
    background: #fff;
    border: 1px solid #e5e7eb;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
  }
  #recTable tbody tr td {
    border: none;
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
  }
  #recTable tbody tr td:first-child {
    border-top-left-radius: 12px;
    border-bottom-left-radius: 12px;
  }
  #recTable tbody tr td:last-child {
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
  }
  #recTable tbody tr:hover {
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
  }
  #recTable input[type="number"].form-control {
    text-align: right;
  }
</style>

<!-- Modal detalhe -->
<div class="modal fade" id="ccModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header cc-modal-header">
        <div class="w-100">
          <div class="d-flex flex-wrap justify-content-between align-items-end gap-2">
            <div>
              <h5 class="modal-title mb-0" id="ccModalTitle">Extrato</h5>
              <div class="small opacity-75" id="ccModalSubtitle"></div>
            </div>
            <div class="d-flex align-items-center gap-3">
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="ccModalPendentesOnly">
                <label class="form-check-label" for="ccModalPendentesOnly">Pendentes</label>
              </div>
              <div class="cc-modal-total text-end">
                <div class="small opacity-75">Saldo em aberto</div>
                <div class="fw-bold" id="ccModalTotal">0</div>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="cc-modal-table-wrap">
          <table class="table table-sm table-hover align-middle mb-0" id="ccModalTable">
            <thead>
              <tr>
                <th style="width:120px;">Data</th>
                <th style="width:120px;">Venc.</th>
                <th style="width:160px;">Doc.</th>
                <th style="width:160px;">N&ordm;</th>
                <th class="text-end" style="width:120px;">D&eacute;bito</th>
                <th class="text-end" style="width:120px;">Cr&eacute;dito</th>
                <th class="text-end" style="width:140px;">Aberto</th>
                <th class="text-end" style="width:140px;">Saldo</th>
                <th style="width:140px;">C. Custo</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="9" class="text-muted p-3">A carregar...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/cc_clientes.js') }}?v={{ static_version }}"></script>
{% endblock %}
