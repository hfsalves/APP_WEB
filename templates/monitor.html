{% extends "base.html" %}

{% block title %}Monitor de Trabalho{% endblock %}

{% block content %}
<!-- Barra de ações superior -->
<div class="mb-2 d-flex align-items-center justify-content-between">
  <div class="d-flex align-items-center gap-2">
    <button class="btn btn-outline-secondary btn-sm" id="openFilters">
      <i class="fa-solid fa-filter me-1"></i>
      Filtros
    </button>
  </div>
  <small class="text-muted" id="filtersSummary"></small>
</div>

<!-- layout: 5 colunas quando existir a coluna de MN -->
<div class="row gx-3 gy-3 row-cols-1 row-cols-md-5">
  <!-- Coluna nova: Manutenções não agendadas (mostrada só para MNADMIN) -->
  <div id="col-mn-nao-agendadas">
    <div class="col-header bg-light border rounded px-2 py-1 mb-2 d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Pendentes</span>
      <span class="badge bg-secondary" id="count-mn">0</span>
    </div>
    <div id="mn-nao-agendadas" class="tarefa-coluna"></div>
  </div>

  <div>
    <div class="col-header bg-light border rounded px-2 py-1 mb-2 d-flex justify-content-between align-items-center">
      <span class="fw-semibold text-danger">Atrasadas</span>
      <span class="badge bg-secondary" id="count-atrasadas">0</span>
    </div>
    <div id="tarefas-atrasadas" class="tarefa-coluna"></div>
  </div>
  <div>
    <div class="col-header bg-light border rounded px-2 py-1 mb-2 d-flex justify-content-between align-items-center">
      <span class="fw-semibold text-warning">Hoje</span>
      <span class="badge bg-secondary" id="count-hoje">0</span>
    </div>
    <div id="tarefas-hoje" class="tarefa-coluna"></div>
  </div>
  <div>
    <div class="col-header bg-light border rounded px-2 py-1 mb-2 d-flex justify-content-between align-items-center">
      <span class="fw-semibold text-success">Futuras</span>
      <span class="badge bg-secondary" id="count-futuras">0</span>
    </div>
    <div id="tarefas-futuras" class="tarefa-coluna"></div>
  </div>
  <div>
    <div class="col-header bg-light border rounded px-2 py-1 mb-2 d-flex justify-content-between align-items-center">
      <span class="fw-semibold text-muted">Tratadas</span>
      <span class="badge bg-secondary" id="count-tratadas">0</span>
    </div>
    <div id="tarefas-tratadas" class="tarefa-coluna"></div>
  </div>
</div>

<!-- Variáveis globais seguras -->
<script>
  window.CURRENT_USER = "{{ current_user.LOGIN }}";
  // evita erro se não existir o campo (ex.: perfis antigos)
  window.IS_MN_ADMIN = {{ (current_user.MNADMIN or 0)|int }};
  window.IS_LP_ADMIN = {{ (current_user.LPADMIN or 0)|int }};
  window.CAN_OPEN_RS = {{ 1 if (user_perms.get('RS', {}).get('consultar', False)) else 0 }};
  window.CAN_OPEN_TAREFAS = {{ 1 if (user_perms.get('TAREFAS', {}).get('consultar', False)) else 0 }};
  window.CAN_OPEN_LP = {{ 1 if (user_perms.get('LP', {}).get('consultar', False)) else 0 }};
  window.CAN_OPEN_MN = {{ 1 if can_open_mn else 0 }};
  window.CAN_OPEN_FS = {{ 1 if can_open_fs else 0 }};
  window.IS_ADMIN = {{ 1 if (current_user.ADMIN if current_user.is_authenticated else False) else 0 }};
  document.addEventListener('DOMContentLoaded', () => {
    const col = document.getElementById('col-mn-nao-agendadas');
    if (!window.IS_MN_ADMIN && col) col.style.display = 'none';
    // Controla visibilidade dos itens do FAB conforme permissões
    try {
      const btnNR = document.getElementById('openNotasReserva');
      if (btnNR && !window.CAN_OPEN_RS) btnNR.style.display = 'none';
      const btnNT = document.getElementById('openNotaTarefa');
      if (btnNT && !window.CAN_OPEN_TAREFAS) btnNT.style.display = 'none';
    } catch(_) {}
  });
</script>

<!-- Modal de Filtros -->
<div class="modal fade" id="filtersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-filter me-2"></i>Filtros</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="btn-group mb-2 filters-tabs" role="group" aria-label="Tabs filtros">
          <button type="button" class="btn btn-outline-primary active" id="filtersTabUsers">Utilizadores</button>
          <button type="button" class="btn btn-outline-primary" id="filtersTabAloj">Alojamentos</button>
          <button type="button" class="btn btn-outline-primary" id="filtersTabOrigins">Origens</button>
        </div>

        <div class="filters-list-wrapper">
          <div id="filtersList" class="filters-list"></div>
        </div>
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" id="filtersSelectAll">Todos</button>
          <button type="button" class="btn btn-outline-secondary" id="filtersSelectNone">Nenhum</button>
          <button type="button" class="btn btn-outline-secondary" id="filtersClear">Limpar filtros</button>
        </div>
        <div>
          <button type="button" class="btn btn-cancel me-2" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="filtersApply">Aplicar</button>
        </div>
      </div>
    </div>
  </div>
  <style>
    /* Modal filters layout */
    #filtersModal .modal-body { display: flex; flex-direction: column; overflow: hidden; }
    #filtersModal .filters-tabs { background: #fff; z-index: 2; padding-top: .25rem; padding-bottom: .25rem; border-bottom: 1px solid #eee; }
    #filtersModal .filters-list-wrapper { flex: 1 1 auto; overflow: auto; padding: 0 8px 0 6px; }
    #filtersModal .filters-list { display: grid; grid-template-columns: 1fr; gap: .5rem; padding-top: .25rem; padding-bottom: .25rem; }

    /* Loading state for filters list */
    #filtersModal .filters-list-wrapper.loading { position: relative; }
    #filtersModal .filters-list-wrapper.loading .filters-list { filter: blur(1px); pointer-events: none; }
    #filtersModal .filters-list-wrapper.loading::before { content: ""; position: absolute; inset: 0; background: rgba(255,255,255,.6); z-index: 3; }
    #filtersModal .filters-list-wrapper.loading::after { content: "A carregar…"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #555; font-size: .95rem; z-index: 4; }

    /* Cards */
    .select-card { cursor: pointer; user-select: none; border: 1px solid #e5e7eb; border-radius: .5rem; padding: .5rem .75rem; background: #fff; margin: 0 2px; }
    .select-card.selected { outline: 2px solid #0d6efd; outline-offset: 2px; background: #f0f7ff; }
    .select-card .badge { font-size: .75rem; }
  </style>
</div>

<!-- Estilo para fazer os cartões de MN ficarem como os das tarefas -->
<style>
  /* Garantir que o modal fica acima de qualquer overlay residual */
  .modal-backdrop { z-index: 10990 !important; }
  .modal { z-index: 11000 !important; }
  .modal * { pointer-events: auto !important; }
  /* Evita que o overlay global de carregamento interfira no Monitor */
  #loadingOverlay { display: none !important; opacity: 0 !important; pointer-events: none !important; }
  /* aproxima visual dos blocos MN aos cards das tarefas */
  #mn-nao-agendadas .tarefa-bloco {
    background: #fff;
    border: 1px solid rgba(0,0,0,.075);
    border-radius: .5rem;
    box-shadow: 0 .125rem .25rem rgba(0,0,0,.075);
    margin-bottom: .5rem;
    padding: .5rem .6rem;
  }
  #mn-nao-agendadas .tarefa-titulo {
    font-weight: 600;
    margin-bottom: .125rem;
  }
  #mn-nao-agendadas .tarefa-subtitulo {
    color: #6c757d;
    font-size: .85rem;
    margin-bottom: .35rem;
  }
  #mn-nao-agendadas .tarefa-acoes .btn {
    padding: .25rem .5rem;
    font-size: .85rem;
  }
  /* Garantir que botões antigos não aparecem por cache/templates alternativos */
  #tarefaModal #btnReagendar,
  #tarefaModal #btnNota { display:none !important; }
  /* Não mostrar ações dentro do card MN (apenas no modal) */
  #mn-nao-agendadas .mn-actions { display: none !important; }
  .user-badge { font-weight:600; border-radius:.5rem; font-size:.70rem; }
  /* reduzir fonte do alojamento no card */
  .tarefa-card .card-body > div > strong,
  .tarefa-card .tarefa-alojamento { font-size:.90rem; }
  /* seleção visual de Notas de Reserva */
  .nr-card.nr-selected {
    border: 2px solid #0d6efd;
    box-shadow: 0 0 0 .15rem rgba(13,110,253,.25);
    background: #f4f8ff;
  }
  /* seleção visual de bloco de Check-Out no modal MN */
  .mn-out-option.mn-selected {
    border: 2px solid #0d6efd !important;
    box-shadow: 0 0 0 .15rem rgba(13,110,253,.25);
    background: #f4f8ff;
  }
  /* filtro bloco clicável */
  .filter-header { cursor: pointer; }
  .filter-header.active { background:#0d6efd; color:#fff; border-color:#0d6efd; }
  .filter-header.active .form-check-input { border-color:#fff; }
  .filter-header.active .form-check-label { color:#fff; }
  .filter-header.active .badge { background: rgba(255,255,255,.25); color:#fff; }
  /* Não mostrar botão Abrir nas cards das tarefas (passou para o modal) */
  .tarefa-card a[href*="/generic/form/TAREFAS/"] { display:none !important; }
  /* Headers de grupos na coluna Futuras */
  #tarefas-futuras > .bg-light.border.rounded.px-2.py-1.mb-2.d-flex.justify-content-between.align-items-center {
    background-color: #eef6ff; /* cor diferenciada */
    border-color: #cfe7ff;
    color: #0b5ed7;
  }
  #tarefas-futuras > .bg-light.border.rounded.px-2.py-1.mb-2.d-flex.justify-content-between.align-items-center span {
    font-size: .85rem; /* texto mais pequeno */
    font-weight: 700;  /* negrito */
  }
  /* Cartões de alojamentos no modal */
  #alojList .al-card { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem .75rem; background:#fff; }
  #alojList .al-title { font-weight:700; }
  #alojList .al-line { color:#6b7280; font-size:.9rem; }
  #alojList .al-open { float:right; }
  /* Alojamentos modal: limitar altura e tornar lista scrollável */
  #alojModal .modal-content { max-height: 90vh; display: flex; flex-direction: column; }
  #alojModal .modal-body { flex: 1 1 auto; overflow: auto; }
</style>

<!-- FAB -->
<div id="fab-actions" style="position: absolute; top: 22px; right: 34px; z-index: 3000;">
  <button class="fab-btn" id="openFabMenu" title="Ações rápidas">
    <i class="fa-solid fa-ellipsis-vertical"></i>
  </button>
  <div class="fab-menu" id="fabMenu" style="display: none;">
    <button class="fab-menu-item" id="openNovaMn">Nova Incidência</button>
    <button class="fab-menu-item" id="openNovaFalta">Nova Falta</button>
    <button class="fab-menu-item" id="openNotasReserva">Notas de Reserva</button>
    <button class="fab-menu-item" id="openAlojamentos">Alojamentos</button>
    <button class="fab-menu-item" id="openNotaTarefa">Nova Tarefa</button>
  </div>
</div>

<!-- Modal de Ações (tarefas) -->
<div class="modal fade" id="tarefaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tarefa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p id="tarefaDescricao"></p>
        <div id="tarefaAnexos" class="anexo-queue mt-2"></div>
        <div id="tarefaInfo" class="mt-3" style="white-space:pre-wrap;"></div>
        <div class="d-flex justify-content-between flex-wrap gap-2">
          <button id="btnTratar" class="btn btn-success">Marcar como tratada</button>
          <button id="btnReabrir" class="btn btn-warning" style="display:none;">Reabrir tarefa</button>
          <button id="btnAbrirTarefa" class="btn btn-primary" style="display:none;">Abrir</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Notas de Reserva -->
<div class="modal fade" id="nrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Notas de Reserva</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="nrForm" onsubmit="return false;">
          <div class="row g-2 align-items-end mb-2">
            <div class="col-12 col-md-4">
              <label for="nrDataIn" class="form-label">Data de CheckIn</label>
              <input type="date" id="nrDataIn" class="form-control" />
            </div>
            <div class="col-12 col-md-4">
              <label for="nrReserva" class="form-label">Reserva</label>
              <input type="text" id="nrReserva" class="form-control" placeholder="Código da reserva" />
            </div>
            <div class="col-12 col-md-4">
              <button type="button" id="nrBuscar" class="btn btn-primary">Procurar</button>
            </div>
          </div>
        </form>

        <div id="nrResultados" class="mt-2"></div>

        <div id="nrObsArea" class="mt-3" style="display:none;">
          <label for="nrObs" class="form-label">Observações</label>
          <textarea id="nrObs" class="form-control" rows="4" placeholder="Escreve aqui as observações..."></textarea>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="nrBerco">
            <label class="form-check-label" for="nrBerco">Fazer Berço</label>
          </div>
          <div class="form-check mt-1">
            <input class="form-check-input" type="checkbox" id="nrSofa">
            <label class="form-check-label" for="nrSofa">Fazer Sofá Cama</label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary me-auto" id="nrAbrir" disabled>Abrir</button>
        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="nrGravar">Gravar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Anexar Ficheiros/Fotos -->
<div class="modal fade" id="anexoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" id="anexoForm" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Anexos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="anexoTable" name="table" value="" />
        <input type="hidden" id="anexoRec" name="rec" value="" />
        <div class="mb-2">
          <label for="anexoDescricao" class="form-label">Descrição (opcional)</label>
          <input type="text" id="anexoDescricao" name="descricao" class="form-control" maxlength="200" />
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2">
          <small class="text-muted">Podes adicionar várias fotos, vídeos ou ficheiros.</small>
          <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddAnexo">
            <i class="fa fa-paperclip me-1"></i>Novo anexo
          </button>
        </div>
        <input type="file" id="anexoFile" style="display:none" multiple accept="image/*,video/*,application/pdf,.doc,.docx,.xls,.xlsx,.zip,.txt" capture="environment" />

        <div id="anexoQueue" class="anexo-queue"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="anexoUploadBtn">Gravar</button>
      </div>
    </form>
  </div>
</div>

<style>
  #anexoModal .modal-content { max-height: 90vh; display:flex; flex-direction:column; }
  #anexoModal .modal-body { overflow:auto; }
  #anexoModal .anexo-queue { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:.5rem; }
  #anexoModal .anexo-item { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem; background:#fff; position:relative; }
  #anexoModal .anexo-thumb { width:100%; height:100px; object-fit:cover; border-radius:.25rem; background:#f3f4f6; display:block; }
  #anexoModal .anexo-name { font-size:.8rem; margin-top:.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #anexoModal .anexo-remove { position:absolute; top:4px; right:4px; border:none; background:rgba(0,0,0,.55); color:#fff; border-radius:12px; width:24px; height:24px; line-height:24px; text-align:center; cursor:pointer; }
  /* Simplificar modal de anexos: esconder descrio e nota */
  #anexoModal .modal-body > .mb-2:first-of-type { display:none !important; }
  #anexoModal .modal-body > .d-flex.align-items-center.mb-2 { justify-content:end !important; }
  #anexoModal .modal-body > .d-flex.align-items-center.mb-2 small { display:none !important; }
  /* Agendar MN: limitar altura do modal e cards de check-out scrollveis */
  #agendarModal .modal-content { max-height: 90vh; display: flex; flex-direction: column; }
  #agendarModal .modal-body { display: block; overflow: auto; }
  /* Thumbs de anexos no agendarModal (igual ao anexoModal) */
  #agendarModal .anexo-queue { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:.5rem; }
  #agendarModal .anexo-item { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem; background:#fff; position:relative; }
  #agendarModal .anexo-thumb { width:100%; height:100px; object-fit:cover; border-radius:.25rem; background:#f3f4f6; display:block; }
  #agendarModal .anexo-name { font-size:.8rem; margin-top:.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  #agendarModal #mnOutOptions { overflow: visible; padding-right: 0; }
  #agendarModal #mnOutOptions .mn-out-option { border:1px solid #e5e7eb; border-radius:.5rem; background:#fff; }
  /* Thumbs no modal de Tarefa */
  #tarefaModal .anexo-queue { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:.5rem; }
  #tarefaModal .anexo-item { border:1px solid #e5e7eb; border-radius:.5rem; padding:.5rem; background:#fff; position:relative; }
  #tarefaModal .anexo-thumb { width:100%; height:100px; object-fit:cover; border-radius:.25rem; background:#f3f4f6; display:block; }
  #tarefaModal .anexo-name { font-size:.8rem; margin-top:.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
</style>

<style>
  /* Notas de Reserva: altura máxima e resultados scrolláveis */
  #nrModal .modal-content { max-height: 90vh; display: flex; flex-direction: column; }
  #nrModal .modal-body { flex: 1 1 auto; overflow: hidden; display: flex; flex-direction: column; }
  #nrResultados { flex: 1 1 auto; overflow: auto; }
</style>

<!-- Modal: Nova Falta (FS) -->
<div class="modal fade" id="novaFaltaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="novaFaltaForm">
      <div class="modal-header">
        <h5 class="modal-title">Nova Falta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label for="nfUser" class="form-label">Utilizador</label>
          <select id="nfUser" class="form-select"></select>
        </div>
        <div class="mb-2">
          <label for="nfAloj" class="form-label">Alojamento</label>
          <select id="nfAloj" class="form-select"></select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label for="nfData" class="form-label">Data</label>
            <input type="date" id="nfData" class="form-control" />
          </div>
          <div class="col-6 d-flex align-items-end">
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="nfUrgente">
              <label class="form-check-label" for="nfUrgente">Urgente</label>
            </div>
          </div>
        </div>
        <div class="mb-2 mt-2">
          <label for="nfItem" class="form-label">Item</label>
          <input type="text" id="nfItem" class="form-control" placeholder="Descreve o item em falta" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="nfGravar">Gravar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Alojamentos -->
<div class="modal fade" id="alojModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Alojamentos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="alojList" class="row g-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Falta (FS) -->
<div class="modal fade" id="fsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Falta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="fsStamp" />
        <div id="fsResumo" class="mb-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="fsTratadaBtn">Marcar como tratada</button>
        <button type="button" class="btn btn-primary" id="fsAbrirBtn">Abrir</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Nova Tarefa -->
<div class="modal fade" id="notaTarefaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="notaTarefaForm">
      <div class="modal-header">
        <h5 class="modal-title">Nova Tarefa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label for="ntUser" class="form-label">Utilizador</label>
          <select id="ntUser" class="form-select"></select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label for="ntData" class="form-label">Data</label>
            <input type="date" id="ntData" class="form-control" />
          </div>
          <div class="col-6">
            <label for="ntHora" class="form-label">Hora</label>
            <input type="time" id="ntHora" class="form-control" />
          </div>
        </div>
        <div class="mb-2 mt-2">
          <label for="ntDuracao" class="form-label">Duração (min)</label>
          <input type="number" id="ntDuracao" class="form-control" min="1" step="1" />
        </div>
        <div class="mb-2">
          <label for="ntTarefa" class="form-label">Tarefa</label>
          <input type="text" id="ntTarefa" class="form-control" placeholder="Descreve a tarefa" />
        </div>
        <div class="mb-2">
          <label for="ntAloj" class="form-label">Alojamento</label>
          <select id="ntAloj" class="form-select">
            <option value="">(Sem alojamento)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="ntGravar">Gravar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal de Agendamento (para MN não agendadas) -->
<div class="modal fade" id="agendarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <form class="modal-content" id="agendarForm">
      <div class="modal-header">
        <h5 class="modal-title">Agendar manutenção</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="mnResumo" class="mb-2"></div>
        <input type="hidden" id="agendarMNStamp" />

        <div class="row g-2">
          <div class="col-6">
            <label for="agendarData" class="form-label">Data</label>
            <input type="date" class="form-control" id="agendarData" required>
          </div>
          <div class="col-6">
            <label for="agendarHora" class="form-label">Hora</label>
            <input type="time" class="form-control" id="agendarHora" required>
          </div>
        </div>

        <div class="mb-3">
          <label for="agendarUser" class="form-label">Utilizador</label>
          <select class="form-select" id="agendarUser"></select>
        </div>
        <!-- Thumbnails de anexos da MN -->
        <div id="mnAnexos" class="anexo-queue mt-2"></div>
        <div id="mnOutOptions" class="mt-2"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="mnTratadaBtn">Marcar como tratada</button>
        <button type="submit" class="btn btn-warning" id="agendarConfirm">Agendar</button>
        <button type="button" class="btn btn-primary" id="mnAbrirBtn">Abrir</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Nova Incidência (MN) -->
<div class="modal fade" id="novaMnModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="novaMnForm">
      <div class="modal-header">
        <h5 class="modal-title">Nova Incidência</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label for="nmUser" class="form-label">Utilizador</label>
          <select id="nmUser" class="form-select"></select>
        </div>
        <div class="mb-2">
          <label for="nmAloj" class="form-label">Alojamento</label>
          <select id="nmAloj" class="form-select"></select>
        </div>
        <div class="row g-2">
          <div class="col-6">
            <label for="nmData" class="form-label">Data</label>
            <input type="date" id="nmData" class="form-control" />
          </div>
          <div class="col-6 d-flex align-items-end">
            <div class="form-check mt-3">
              <input class="form-check-input" type="checkbox" id="nmUrgente">
              <label class="form-check-label" for="nmUrgente">Urgente</label>
            </div>
          </div>
        </div>
        <div class="mb-2 mt-2">
          <label for="nmIncidencia" class="form-label">Incidência</label>
          <textarea id="nmIncidencia" class="form-control" rows="3" placeholder="Descreve a incidência"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="nmGravar">Gravar</button>
      </div>
    </form>
  </div>
</div>

<!-- Preenche o combo de utilizadores e sincroniza com window.CURRENT_USER -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    // só precisamos disto se o modal existir (página do monitor)
    const sel = document.getElementById('agendarUser');
    if (!sel) return;

    try {
      // usa o endpoint genérico de options com 1 coluna
      const q = encodeURIComponent("SELECT LOGIN FROM US ORDER BY 1");
      const r = await fetch(`/generic/api/options?query=${q}`);
      const js = await r.json();
      const opts = Array.isArray(js) ? js : (Array.isArray(js.options) ? js.options : []);

      sel.innerHTML = opts.map(o => `<option value="${o.value}">${o.text}</option>`).join('') ||
                      `<option value="${window.CURRENT_USER}">${window.CURRENT_USER}</option>`;

      // valor por defeito: utilizador atual
      sel.value = window.CURRENT_USER || (opts[0]?.value ?? '');

      // quando mudar, atualiza a variável global que o monitor.js usa no POST
      sel.addEventListener('change', () => {
        window.CURRENT_USER = sel.value;
      });

      // quando o modal abre, garante que seleciona o atual
      const modalEl = document.getElementById('agendarModal');
      if (modalEl) {
        modalEl.addEventListener('shown.bs.modal', () => {
          sel.value = window.CURRENT_USER || sel.value;
        });
      }
    } catch (e) {
      console.warn('Não foi possível carregar utilizadores:', e);
      // fallback: mantém o current_user como única opção
      sel.innerHTML = `<option value="${window.CURRENT_USER}">${window.CURRENT_USER}</option>`;
      sel.value = window.CURRENT_USER;
    }
  });
</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/monitor.js') }}"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('openAlojamentos');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        // Abre imediatamente o modal e mostra estado de carregamento
        const modalEl = document.getElementById('alojModal');
        if (modalEl) bootstrap.Modal.getOrCreateInstance(modalEl).show();
        const list = document.getElementById('alojList');
        if (list) list.innerHTML = '<div class="text-muted small px-1">A carregar</div>';
        const menu = document.getElementById('fabMenu');
        if (menu) menu.style.display = 'none';

        try {
          const r = await fetch('/api/alojamentos');
          const js = await r.json();
          const rows = Array.isArray(js.rows) ? js.rows : [];
          const canOpen = !!js.can_open;
          if (list) list.innerHTML = '';
          const esc = s => String(s ?? '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));

          // Render em blocos para manter a UI responsiva
          let i = 0;
          const chunk = 25;
          (function renderChunk(){
            const end = Math.min(i + chunk, rows.length);
            for (; i < end; i++) {
              const al = rows[i];
              const col = document.createElement('div');
              col.className = 'col-12';
              const morada = [al.MORADA, al.CODPOST, al.LOCAL].filter(Boolean).join(' • ');
              const tip = [al.TIPOLOGIA, (al.LOTACAO ? al.LOTACAO + ' Hóspedes' : null)].filter(Boolean).join(' • ');
              const codigos = Array.isArray(al.CODIGOS) ? al.CODIGOS : [];
              let codHtml = '';
              for (const c of codigos) {
                codHtml += `<div class=\"al-line\"><span class=\"fw-semibold\">${esc(c.CARACTERISTICA)}</span>: ${esc(c.VALOR)}</div>`;
              }
              const openBtn = canOpen ? `<a class=\"btn btn-sm btn-primary al-open\" href=\"/generic/form/AL/${encodeURIComponent(al.ALSTAMP)}?return_to=/monitor\">Abrir</a>` : '';
              col.innerHTML = `
                <div class=\"al-card\">
                  <div class=\"d-flex justify-content-between\">
                    <div class=\"al-title\">${esc(al.NOME || '')}</div>
                    ${openBtn}
                  </div>
                  <div class=\"al-line\">${esc([al.MORADA, al.CODPOST, al.LOCAL].filter(Boolean).join(' ' + String.fromCharCode(8226) + ' '))}</div>
                  <div class=\"al-line\">${esc([al.TIPOLOGIA, (al.LOTACAO ? al.LOTACAO + ' H' + String.fromCharCode(243) + 'spedes' : null)].filter(Boolean).join(' ' + String.fromCharCode(8226) + ' '))}</div>
                  ${codHtml}
                </div>`;
              if (list) list.appendChild(col);
            }
            if (i < rows.length) setTimeout(renderChunk, 0);
          })();
        } catch (e) {
          if (list) list.innerHTML = `<div class=\"text-danger small px-1\">Erro ao carregar alojamentos: ${ (e && e.message) ? e.message.replace(/</g,'&lt;') : e }</div>`;
        }
      });
    });
  </script>
  <script>
    // Nova Incidência (MN): abrir modal, combos, defaults e submit
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('openNovaMn');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const modalEl = document.getElementById('novaMnModal');
        if (!modalEl) return;
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        const userSel = document.getElementById('nmUser');
        const alojSel = document.getElementById('nmAloj');
        const dataEl  = document.getElementById('nmData');
        const incEl   = document.getElementById('nmIncidencia');
        const urgEl   = document.getElementById('nmUrgente');

        try {
          // Users
          const qu = encodeURIComponent("SELECT LOGIN FROM US WHERE ISNULL(INATIVO,0)=0 ORDER BY 1");
          const ru = await fetch(`/generic/api/options?query=${qu}`);
          const ou = await ru.json();
          const listU = Array.isArray(ou) ? ou : (ou.options || []);
          if (userSel) {
            userSel.innerHTML = listU.map(o => `<option value=\"${o.value}\">${o.text}</option>`).join('');
            userSel.value = window.CURRENT_USER || (listU[0]?.value ?? '');
          }
          // Alojamentos
          const qa = encodeURIComponent("SELECT NOME FROM AL WHERE ISNULL(INATIVO,0)=0 ORDER BY 1");
          const ra = await fetch(`/generic/api/options?query=${qa}`);
          const oa = await ra.json();
          const listA = Array.isArray(oa) ? oa : (oa.options || []);
          if (alojSel) {
            alojSel.innerHTML = listA.map(o => `<option value=\"${o.value}\">${o.text}</option>`).join('');
          }
        } catch (_) {}

        // Defaults
        const hoje = new Date();
        if (dataEl) dataEl.value = hoje.toISOString().slice(0,10);
        if (incEl) incEl.value = '';
        if (urgEl) urgEl.checked = false;

        const menu = document.getElementById('fabMenu');
        if (menu) menu.style.display = 'none';
        modal.show();
      });

      const form = document.getElementById('novaMnForm');
      if (form) form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const NOME = document.getElementById('nmUser')?.value || window.CURRENT_USER || '';
        const ALOJAMENTO = document.getElementById('nmAloj')?.value || '';
        const DATA = document.getElementById('nmData')?.value || '';
        const INCIDENCIA = document.getElementById('nmIncidencia')?.value?.trim() || '';
        const URGENTE = !!document.getElementById('nmUrgente')?.checked;
        if (!ALOJAMENTO || !DATA || !NOME || !INCIDENCIA) { alert('Preenche utilizador, alojamento, data e incidência.'); return; }
        try {
          const resp = await fetch('/generic/api/mn_incidente', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ NOME, ALOJAMENTO, DATA, INCIDENCIA, URGENTE })
          });
          const js = await resp.json();
          if (!resp.ok || js.success === false) throw new Error(js.error || 'Falha ao gravar incidência');
          const modalEl = document.getElementById('novaMnModal');
          if (modalEl) { const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); modal.hide(); }
          if (typeof loadPendentes === 'function') loadPendentes();
          try {
            const stamp = js.MNSTAMP || js.mnSTAMP || js.mnstamp || js.MNSTAMP || '';
            if (stamp && typeof window.askAddAnexosForMN === 'function') {
              window.askAddAnexosForMN(stamp);
            }
          } catch(_){ }        } catch (e) {
          alert(e.message || 'Erro ao gravar incidência');
        }
      });
    });
  </script>
  <script>
    // Nova Falta (FS): abrir modal, preencher combos, defaults e submeter
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('openNovaFalta');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const modalEl = document.getElementById('novaFaltaModal');
        if (!modalEl) return;
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        const userSel = document.getElementById('nfUser');
        const alojSel = document.getElementById('nfAloj');
        const dataEl  = document.getElementById('nfData');
        const itemEl  = document.getElementById('nfItem');
        const urgEl   = document.getElementById('nfUrgente');

        try {
          // Users
          const qu = encodeURIComponent("SELECT LOGIN FROM US WHERE ISNULL(INATIVO,0)=0 ORDER BY 1");
          const ru = await fetch(`/generic/api/options?query=${qu}`);
          const ou = await ru.json();
          const listU = Array.isArray(ou) ? ou : (ou.options || []);
          if (userSel) {
            userSel.innerHTML = listU.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
            userSel.value = window.CURRENT_USER || (listU[0]?.value ?? '');
          }
          // Alojamentos
          const qa = encodeURIComponent("SELECT NOME FROM AL WHERE ISNULL(INATIVO,0)=0 ORDER BY 1");
          const ra = await fetch(`/generic/api/options?query=${qa}`);
          const oa = await ra.json();
          const listA = Array.isArray(oa) ? oa : (oa.options || []);
          if (alojSel) {
            alojSel.innerHTML = listA.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
          }
        } catch (_) {}

        // Defaults
        const hoje = new Date();
        if (dataEl) dataEl.value = hoje.toISOString().slice(0,10);
        if (itemEl) itemEl.value = '';
        if (urgEl) urgEl.checked = false;

        const menu = document.getElementById('fabMenu');
        if (menu) menu.style.display = 'none';
        modal.show();
      });

      const form = document.getElementById('novaFaltaForm');
      if (form) form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const USERNAME = document.getElementById('nfUser')?.value || window.CURRENT_USER || '';
        const ALOJAMENTO = document.getElementById('nfAloj')?.value || '';
        const DATA = document.getElementById('nfData')?.value || '';
        const ITEM = document.getElementById('nfItem')?.value?.trim() || '';
        const URGENTE = !!document.getElementById('nfUrgente')?.checked;
        if (!ALOJAMENTO || !DATA || !USERNAME || !ITEM) { alert('Preenche utilizador, alojamento, data e item.'); return; }
        try {
          const resp = await fetch('/generic/api/fs_falta', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ USERNAME, ALOJAMENTO, DATA, ITEM, URGENTE })
          });
          const js = await resp.json();
          if (!resp.ok || js.success === false) throw new Error(js.error || 'Falha ao gravar falta');
          const modalEl = document.getElementById('novaFaltaModal');
          if (modalEl) { const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); modal.hide(); }
          if (typeof loadPendentes === 'function') loadPendentes();
        } catch (e) {
          alert(e.message || 'Erro ao gravar falta');
        }
      });
    });
  </script>
  <script>
    // Nota Tarefa: abrir e preencher combos/defaults + submit
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('openNotaTarefa');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        const modalEl = document.getElementById('notaTarefaModal');
        if (!modalEl) return;
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        const userSel = document.getElementById('ntUser');
        const alojSel = document.getElementById('ntAloj');
        const dataIn  = document.getElementById('ntData');
        const horaIn  = document.getElementById('ntHora');
        const durIn   = document.getElementById('ntDuracao');
        const tarefaIn= document.getElementById('ntTarefa');

        // defaults
        try {
          // Utilizadores
          const qu = encodeURIComponent("SELECT LOGIN FROM US WHERE ISNULL(INATIVO,0)=0 ORDER BY 1");
          const ru = await fetch(`/generic/api/options?query=${qu}`);
          const ou = await ru.json();
          const listU = Array.isArray(ou) ? ou : (ou.options || []);
          if (userSel) {
            userSel.innerHTML = listU.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
            userSel.value = window.CURRENT_USER || (listU[0]?.value ?? '');
          }

          // Alojamentos
          const qa = encodeURIComponent("SELECT NOME FROM AL WHERE ISNULL(INATIVO,0)=0 ORDER BY 1");
          const ra = await fetch(`/generic/api/options?query=${qa}`);
          const oa = await ra.json();
          const listA = Array.isArray(oa) ? oa : (oa.options || []);
          if (alojSel) {
            alojSel.innerHTML = '<option value="">(Sem alojamento)</option>' +
              listA.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
            alojSel.value = '';
          }
        } catch (_) { /* ignora */ }

        // Data = hoje
        const hoje = new Date();
        if (dataIn) dataIn.value = hoje.toISOString().slice(0,10);
        // Hora = próxima meia-hora
        const m = new Date(hoje);
        m.setMinutes(m.getMinutes() < 30 ? 30 : 60, 0, 0);
        const hh = String(m.getHours()).padStart(2,'0');
        const mm = String(m.getMinutes()).padStart(2,'0');
        if (horaIn) horaIn.value = `${hh}:${mm}`;
        // Duração = 60
        if (durIn) durIn.value = 60;
        if (tarefaIn) tarefaIn.value = '';

        // fecha menu FAB
        const menu = document.getElementById('fabMenu');
        if (menu) menu.style.display = 'none';

        modal.show();
      });

      const form = document.getElementById('notaTarefaForm');
      if (form) form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = document.getElementById('ntUser')?.value || window.CURRENT_USER || '';
        const data = document.getElementById('ntData')?.value || '';
        const hora = document.getElementById('ntHora')?.value || '';
        const dur  = parseInt(document.getElementById('ntDuracao')?.value || '60', 10);
        const tarefa = document.getElementById('ntTarefa')?.value?.trim() || '';
        const aloj = document.getElementById('ntAloj')?.value || '';
        if (!tarefa) { alert('Indica a descrição da tarefa.'); return; }
        if (!data || !hora || !Number.isFinite(dur) || dur <= 0) { alert('Verifica data, hora e duração.'); return; }
        try {
          const resp = await fetch('/generic/api/tarefas/nova', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ UTILIZADOR: user, DATA: data, HORA: hora, DURACAO: dur, TAREFA: tarefa, ALOJAMENTO: aloj })
          });
          const js = await resp.json();
          if (!resp.ok || js.ok === false) throw new Error(js.error || 'Falha ao criar tarefa');
          // fechar modal e refrescar
          const modalEl = document.getElementById('notaTarefaModal');
          if (modalEl) { const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); modal.hide(); }
          if (typeof window.loadTarefas === 'function') window.loadTarefas(); else window.location.reload();
        } catch (e) {
          alert(e.message || 'Erro ao criar tarefa');
        }
      });
    });
  </script>
  <script>
    // Esconder o FAB quando qualquer modal relevante estiver aberto (evita bloquear o header do modal)
    document.addEventListener('DOMContentLoaded', () => {
      const fab = document.getElementById('fab-actions');
      const modalIds = ['agendarModal','fsModal','notaTarefaModal','novaMnModal','novaFaltaModal','nrModal','alojModal'];
      if (!fab) return;
      modalIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener('shown.bs.modal', () => { fab.style.display = 'none'; });
        el.addEventListener('hidden.bs.modal', () => { fab.style.display = ''; });
      });
    });
  </script>
  <script>
    // Re-implementação segura do Agendar MN: neutraliza handlers antigos e usa fluxo simples
    document.addEventListener('DOMContentLoaded', () => {
      function esc(s){ return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

      async function fillCheckouts(aloj){
        const optsEl = document.getElementById('mnOutOptions');
        if (!optsEl) return;
        optsEl.innerHTML = '<div class="text-muted small">A carregar...</div>';
        try {
          const r = await fetch(`/generic/api/monitor/outs?alojamento=${encodeURIComponent(aloj)}`);
          const js = await r.json();
          const rows = Array.isArray(js.rows) ? js.rows : [];
          if (!rows.length){ optsEl.innerHTML = '<div class="text-muted small">Sem check-outs futuros.</div>'; return; }
          const fmt = d => { try { const dt = new Date(d); return `${String(dt.getDate()).padStart(2,'0')}/${String(dt.getMonth()+1).padStart(2,'0')}` } catch{ return d } };
          optsEl.innerHTML = '';
          rows.forEach(rw => {
            const co = `${fmt(rw.DATAOUT)}${rw.HORAOUT && rw.HORAOUT !== 'N/D' ? '  ' + rw.HORAOUT : ''}`;
            const ci = `${fmt(rw.DATAIN||'')}${rw.HORAIN ? '  ' + rw.HORAIN : ''}`;
            const div = document.createElement('div');
            div.className = 'mn-out-option border rounded p-2 mb-2';
            div.innerHTML = `<div><strong>Check-Out:</strong> ${esc(co)}</div><div class=\"small text-muted\"><strong>Check-In:</strong> ${esc(ci)}</div>`;
            div.addEventListener('click', () => {
              const dEl = document.getElementById('agendarData');
              const hEl = document.getElementById('agendarHora');
              if (dEl && rw.DATAOUT) dEl.value = rw.DATAOUT;
              if (hEl) hEl.value = (rw.HORAOUT && rw.HORAOUT !== 'N/D') ? rw.HORAOUT : '11:00';
              // seleção visual
              try { optsEl.querySelectorAll('.mn-out-option').forEach(el => el.classList.remove('mn-selected')); div.classList.add('mn-selected'); } catch{}
            });
            optsEl.appendChild(div);
          });
        } catch(e){ optsEl.innerHTML = '<div class="text-muted small">Sem informação disponível.</div>'; }
      }

      async function openMnAgendar(data){
        const { mnstamp, aloj, nome, data: dref } = data || {};
        const modalEl = document.getElementById('agendarModal');
        if (!modalEl) return;
        // preencher hidden e defaults
        try { const hid = document.getElementById('agendarMNStamp'); if (hid) hid.value = mnstamp || ''; } catch{}
        try {
          const now = new Date();
          const dEl = document.getElementById('agendarData');
          const hEl = document.getElementById('agendarHora');
          if (dEl) dEl.value = now.toISOString().slice(0,10);
          const round = new Date(now); round.setMinutes(round.getMinutes() < 30 ? 30 : 60, 0, 0);
          const hh = String(round.getHours()).padStart(2,'0'); const mm = String(round.getMinutes()).padStart(2,'0');
          if (hEl) hEl.value = `${hh}:${mm}`;
        } catch{}
        // resumo
        try {
          const resumo = document.getElementById('mnResumo');
          if (resumo) resumo.innerHTML = `<div class=\"tarefa-titulo\"><strong>${esc(aloj||'')}</strong></div><div class=\"tarefa-subtitulo text-muted small\">${esc(nome||'')}${(nome&&dref)?'  ':''}${esc(dref||'')}</div>`;
        } catch{}
        // check-outs
        // preenchimento legacy desativado: monitor.js preenche os check-outs
        // if (aloj) fillCheckouts(aloj);
        // handlers: tratar & abrir
        try {
          const btnTratar = document.getElementById('mnTratadaBtn');
          if (btnTratar) btnTratar.onclick = async () => {
            try {
              const r = await fetch('/generic/api/mn/tratar', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ MNSTAMP: mnstamp })});
              const js = await r.json(); if (!r.ok || js.ok === false) throw new Error(js.error||'Falha ao marcar');
              bootstrap.Modal.getOrCreateInstance(modalEl).hide();
              if (typeof window.loadTarefas === 'function') window.loadTarefas();
            } catch(err){ alert(err.message||'Erro'); }
          };
          const btnAbrir = document.getElementById('mnAbrirBtn');
          if (btnAbrir) { btnAbrir.style.display='inline-block'; btnAbrir.onclick=()=>{ if(mnstamp) window.location.href = `/generic/form/MN/${encodeURIComponent(mnstamp)}?return_to=/monitor`; }; }
        } catch{}
        // submit agendar
        try {
          const form = document.getElementById('agendarForm');
          if (form) {
            form.onsubmit = async (e) => {
              e.preventDefault();
              const DATA = document.getElementById('agendarData')?.value || '';
              const HORA = document.getElementById('agendarHora')?.value || '';
              const UTILIZADOR = window.CURRENT_USER || '';
              if (!mnstamp || !DATA || !HORA) { alert('Preenche data e hora'); return; }
              try {
                const resp = await fetch('/generic/api/tarefas/from-mn', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ MNSTAMP: mnstamp, DATA, HORA, UTILIZADOR }) });
                const js = await resp.json(); if (!resp.ok || js.ok === false) throw new Error(js.error||'Falha ao agendar');
                bootstrap.Modal.getOrCreateInstance(modalEl).hide();
                if (typeof window.loadTarefas === 'function') window.loadTarefas();
              } catch(err){ alert(err.message||'Erro ao agendar'); }
            };
          }
        } catch{}
        // mostrar modal
        bootstrap.Modal.getOrCreateInstance(modalEl).show();
      }

      // Wrap de renderMNCardStyled para neutralizar handlers antigos e anexar dataset
      try {
        if (typeof renderMNCardStyled === 'function') {
          const prev = renderMNCardStyled;
          renderMNCardStyled = function(mn){
            const original = prev(mn);
            const clone = original.cloneNode(true);
            clone.classList.add('mn-card-enhanced');
            clone.dataset.mnstamp = mn.MNSTAMP || mn.mnstamp || '';
            clone.dataset.aloj = mn.ALOJAMENTO || '';
            clone.dataset.nome = mn.NOME || mn.UTILIZADOR || '';
            clone.dataset.data = mn.DATA || '';
            clone.addEventListener('click', (evt) => { evt.preventDefault(); evt.stopImmediatePropagation(); openMnAgendar(clone.dataset); });
            original.replaceWith(clone);
            return clone;
          };
        }
      } catch(e) { console.warn('Falha a reconfigurar cards MN:', e); }

      // Delegate: força o nosso handler para todos os cards MN
      document.addEventListener('click', (e) => {
        const el = e.target.closest('.tarefa-manutencao');
        if (!el) return;
        // Interceta sempre e usa dataset (preenchido em monitor.js)
        e.preventDefault();
        e.stopImmediatePropagation();
        const data = el.dataset || {};
        openMnAgendar({ mnstamp: data.mnstamp, aloj: data.aloj, nome: data.nome, data: data.data });
      }, true);
    });
  </script>
  <script>
    // Correo pontual de textos com acentos (Incidncia/Manuteno) no DOM
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const btnNovaMn = document.getElementById('openNovaMn');
        if (btnNovaMn) btnNovaMn.textContent = 'Nova Incidncia';

        const modalNovaMn = document.querySelector('#novaMnModal .modal-title');
        if (modalNovaMn) modalNovaMn.textContent = 'Nova Incidncia';

        const lblInc = document.querySelector('label[for="nmIncidencia"]');
        if (lblInc) lblInc.textContent = 'Incidncia';

        const taInc = document.getElementById('nmIncidencia');
        if (taInc) taInc.placeholder = 'Descreve a incidncia';

        const modalAgendar = document.querySelector('#agendarModal .modal-title');
        if (modalAgendar) modalAgendar.textContent = 'Agendar manuteno';

        const fabBtn = document.getElementById('openFabMenu');
        if (fabBtn) fabBtn.title = 'Aes rpidas';
      } catch (_) {}

      // Normaliza mensagens de alert relacionadas a incidncia/anexos e troca por toast quando for sucesso/aviso/erro de anexos
      try {
        const _alert = window.alert;
        window.alert = function(msg) {
          try {
            if (typeof msg === 'string') {
              msg = msg
                .replace(/incid[^a-z]?ncia/gi, 'incidncia')
                .replace(/Falha ao gravar incid[^a-z]?ncia/gi, 'Falha ao gravar incidncia')
                .replace(/Erro ao gravar incid[^a-z]?ncia/gi, 'Erro ao gravar incidncia')
                .replace(/Uploads conclu[^a-z]?dos/gi, 'Uploads concludos');
              // Converte alertas especficos do fluxo de anexos em toasts
              try {
                const s = String(msg);
                if (/^Enviado(s)?\s+\d+\s+ficheiro(s)?\s+com sucesso\./i.test(s)) {
                  if (window.showToast) window.showToast(s, 'success');
                  return;
                }
                if (/^Uploads\s+conclu/i.test(s)) {
                  if (window.showToast) window.showToast(s, 'warning');
                  return;
                }
                if (/Erro\s+ao\s+enviar\s+anexo\.?/i.test(s)) {
                  if (window.showToast) window.showToast(s, 'danger');
                  return;
                }
                if (/Seleciona\s+pelo\s+menos\s+um\s+ficheiro\.?/i.test(s)) {
                  if (window.showToast) window.showToast(s, 'warning');
                  return;
                }
              } catch (_) {}
            }
          } catch (_) {}
          return _alert(msg);
        };
      } catch (_) {}

      // Simplifica modal de anexos: remove descrio e texto auxiliar, fora alinhamento  direita
      try {
        const modal = document.getElementById('anexoModal');
        if (modal) {
          const body = modal.querySelector('.modal-body');
          if (body) {
            const firstMb2 = body.querySelector('.mb-2');
            if (firstMb2 && firstMb2.querySelector('#anexoDescricao')) firstMb2.remove();
            const hintRow = body.querySelector('.d-flex.align-items-center.mb-2');
            if (hintRow) {
              const small = hintRow.querySelector('small');
              if (small) small.remove();
              hintRow.style.justifyContent = 'end';
            }
          }
        }
      } catch (_) {}
    });
  </script>
{% endblock %}





      // Substitui confirm do fluxo de anexos para MN com texto corrigido
      try {
        if (typeof window.askAddAnexosForMN === 'function') {
          window.askAddAnexosForMN = function(mnStamp) {
            try {
              if (!mnStamp) return;
              const quer = window.confirm('Queres anexar fotos/vdeos  Incidncia agora?');
              if (quer) window.openAnexoModal('MN', mnStamp, '');
            } catch(_){}
          };
        }
      } catch(_){}

