{% extends "base.html" %}

{% set page_title = "Processamento Mensal" %}
{% set page_name = "Processamento Mensal" %}
{% block title %}Processamento Mensal{% endblock %}

{% block content %}
<div class="container-fluid py-3 pm-page">
  <div class="d-flex align-items-center gap-2 flex-wrap mb-3 pm-toolbar">
    <button class="btn btn-sm btn-outline-secondary" id="pmPrev"><i class="fa-solid fa-chevron-left"></i></button>
    <div class="pm-month" id="pmMonthLabel"></div>
    <button class="btn btn-sm btn-outline-secondary" id="pmNext"><i class="fa-solid fa-chevron-right"></i></button>
    <button class="btn btn-sm btn-outline-primary" id="pmAddClientes"><i class="fa-solid fa-user-plus"></i> Adicionar clientes</button>
    <button class="btn btn-sm btn-outline-primary" id="pmCalcValores"><i class="fa-solid fa-calculator"></i> Calcular valores</button>
    <button class="btn btn-sm btn-outline-primary" id="pmFetchDossiers"><i class="fa-solid fa-magnifying-glass"></i> Pesquisar dossiers</button>
    <div class="ms-auto text-muted small" id="pmCount"></div>
  </div>

  <div class="card shadow-sm pm-card">
    <div class="card-body p-0 pm-body">
      <div class="table-responsive pm-table-wrap">
        <table class="table table-sm align-middle mb-0 pm-table">
          <thead class="table-light sticky-top">
            <tr>
              <th>No</th>
              <th>Nome</th>
              <th class="text-end">Comissões</th>
              <th class="text-end">Imputações</th>
              <th class="text-end">Total</th>
              <th class="text-end">Total c/IVA</th>
              <th>Dossier</th>
              <th class="text-end">Valor Dossier</th>
              <th>Fatura TG</th>
              <th class="text-end">Valor Fatura</th>
              <th>Ficheiro</th>
              <th>Enviado</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="pmBody">
            <tr><td colspan="13" class="text-muted p-3">A carregar...</td></tr>
          </tbody>
          <tfoot class="table-light" id="pmFoot">
            <tr>
              <th colspan="5"></th>
              <th></th>
              <th></th>
              <th class="text-end" id="pmTotalDossier"></th>
              <th></th>
              <th class="text-end" id="pmTotalFatura"></th>
              <th colspan="3"></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="pmDrillModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pmDrillTitle">Detalhe</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive pm-drill-wrap">
          <table class="table table-sm align-middle mb-0 pm-drill-table">
            <thead class="table-light sticky-top">
              <tr id="pmDrillHead"></tr>
            </thead>
            <tbody id="pmDrillBody">
              <tr><td class="text-muted p-3">A carregar...</td></tr>
            </tbody>
            <tfoot class="table-light">
              <tr id="pmDrillFoot"></tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="pmClientesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Adicionar clientes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <div class="text-muted small">Clientes sem DM no mês selecionado</div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="pmSelectAll">
              <label class="form-check-label small" for="pmSelectAll">Selecionar todos</label>
            </div>
          </div>
          <div class="table-responsive pm-clientes-wrap">
            <table class="table table-sm align-middle mb-0 pm-clientes-table">
              <thead class="table-light sticky-top">
                <tr>
                  <th style="width:36px;"></th>
                  <th>No</th>
                  <th>Nome</th>
                </tr>
              </thead>
              <tbody id="pmClientesBody">
                <tr><td colspan="3" class="text-muted p-3">A carregar...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-sm btn-primary" id="pmAddClientesSave">Adicionar</button>
        </div>
      </div>
  </div>
</div>

<div class="modal fade" id="pmFaturaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Mover Fatura</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <div class="text-muted small">Fatura</div>
          <div id="pmFaturaNum" class="fw-bold"></div>
        </div>
        <div class="mb-2">
          <div class="text-muted small">Valor</div>
          <div id="pmFaturaVal" class="fw-bold"></div>
        </div>
        <div class="mb-3">
          <div class="text-muted small">Período atual</div>
          <div id="pmFaturaPer" class="fw-bold"></div>
        </div>
        <div>
          <label class="form-label">Mover para período</label>
          <select class="form-select form-select-sm" id="pmFaturaTarget"></select>
          <div class="text-muted small mt-2" id="pmFaturaHint"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-sm btn-primary" id="pmFaturaSave">Gravar</button>
      </div>
    </div>
  </div>
</div>

<style>
  .pm-page{ height: calc(100vh - 120px); display:flex; flex-direction:column; }
  .pm-toolbar{ flex:0 0 auto; }
  .pm-month{
    font-weight:800; font-size:16px; color:#0f172a;
    min-width:140px; text-align:center;
  }
  .pm-card{ flex:1 1 auto; overflow:hidden; }
  .pm-body{ height:100%; }
  .pm-table-wrap{ max-height:100%; overflow:auto; }
  .pm-table{
    border-collapse: separate;
    border-spacing: 0 6px;
    width: 100%;
    min-width: 920px;
    font-size: 12px;
    color: #0f172a;
  }
  .pm-table thead th{
    font-weight:800; text-transform:uppercase; letter-spacing:.05em;
    font-size:11px; color:#334155;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    border-bottom:1px solid rgba(148,163,184,.35);
    padding:.55rem .75rem;
  }
  .pm-table tfoot th{
    position: sticky;
    bottom: 0;
    z-index: 2;
    background: #f8fafc;
    border-top:1px solid rgba(148,163,184,.35);
    font-weight:800;
    font-size:11px;
    padding:.55rem .75rem;
  }
  .pm-table tbody tr{
    background:#fff; border:1px solid #e5e7eb;
    box-shadow:0 6px 18px rgba(15,23,42,.05);
  }
  .pm-table tbody tr td{ padding:.5rem .75rem; border:none; }
  .pm-table tbody tr td:first-child{
    border-top-left-radius:12px; border-bottom-left-radius:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-weight:700;
  }
  .pm-table tbody tr td:last-child{
    border-top-right-radius:12px; border-bottom-right-radius:12px;
  }
  .pm-table tbody tr:hover{
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
  }
  .pm-clientes-wrap{ max-height: 55vh; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
  .pm-clientes-table{
    border-collapse: separate;
    border-spacing: 0 6px;
    width:100%;
    font-size: 12px;
  }
  .pm-clientes-table thead th{
    font-weight:800; text-transform:uppercase; letter-spacing:.05em;
    font-size:11px; color:#334155;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    border-bottom:1px solid rgba(148,163,184,.35);
    padding:.45rem .6rem;
    position: sticky; top: 0; z-index: 2;
  }
  .pm-clientes-table tbody tr{
    background:#fff; border:1px solid #e5e7eb;
    box-shadow:0 6px 18px rgba(15,23,42,.05);
  }
  .pm-clientes-table tbody tr td{
    padding:.5rem .65rem; border:none;
  }
  .pm-clientes-table tbody tr td:first-child{
    border-top-left-radius:12px; border-bottom-left-radius:12px;
  }
  .pm-clientes-table tbody tr td:last-child{
    border-top-right-radius:12px; border-bottom-right-radius:12px;
  }
  .pm-clientes-table tbody tr:hover{
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
  }
  .pm-cell-link{
    cursor:pointer;
    color:#0f172a;
    font-weight:700;
  }
  .pm-cell-link:hover{ color:#1d4ed8; }
  .pm-drill-wrap{ max-height: 60vh; overflow:auto; border:1px solid #e5e7eb; border-radius:12px; }
  .pm-drill-table thead th{
    font-weight:800; text-transform:uppercase; letter-spacing:.05em;
    font-size:10px; color:#334155;
    background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    border-bottom:1px solid rgba(148,163,184,.35);
    padding:.45rem .6rem;
    position: sticky; top: 0; z-index: 2;
  }
  .pm-drill-table{
    font-size:11px;
    color:#0f172a;
  }
  .pm-drill-table tbody tr{
    background:#fff; border:1px solid #e5e7eb;
    box-shadow:0 6px 18px rgba(15,23,42,.05);
  }
  .pm-drill-table tbody tr td{ padding:.45rem .6rem; border:none; }
  .pm-drill-table tbody tr:hover{ background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%); }
  .pm-cancel td.pm-strike{
    text-decoration: line-through;
    color:#94a3b8;
  }
  .pm-drill-table tfoot th{
    font-weight:800; font-size:10px; color:#0f172a;
    border-top:1px solid rgba(148,163,184,.35);
    padding:.45rem .6rem;
    background:#f8fafc;
  }
  .pm-file{
    color:#1d4ed8; text-decoration:none; font-weight:700;
  }
  .pm-badge{
    display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px;
    font-size:11px; font-weight:700; border:1px solid #e5e7eb; background:#f8fafc;
  }
  .pm-badge.y{ background:#dcfce7; border-color:#bbf7d0; color:#166534; }
  .pm-badge.n{ background:#fee2e2; border-color:#fecaca; color:#991b1b; }
  .pm-diff{
    color:#b91c1c;
    font-weight:800;
  }
  .pm-ok > td{
    background:#dcfce7;
    border-color:#bbf7d0;
  }
  .pm-del{
    border:none;
    background: transparent;
    color:#94a3b8;
    width:28px;
    height:28px;
    border-radius:50%;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    transition: all .15s ease;
  }
  .pm-del:hover{
    background:#ef4444;
    color:#fff;
    box-shadow:0 6px 16px rgba(239,68,68,.35);
  }
  .pm-fatura-link{
    cursor:pointer;
    color:#0f172a;
    font-weight:700;
  }
  .pm-fatura-link:hover{ color:#1d4ed8; }
  .pm-missing{
    display:inline-flex;
    align-items:center;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:800;
    background:#ffedd5;
    border:1px solid #fed7aa;
    color:#c2410c;
  }
  .pm-flag{
    display:inline-flex;
    align-items:center;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:800;
    background:#fee2e2;
    border:1px solid #fecaca;
    color:#991b1b;
  }
</style>

<script src="{{ url_for('static', filename='js/processamento_mensal.js') }}?v={{ static_version }}"></script>
{% endblock %}
