{% extends "base.html" %}

{% set page_title = "Compras" %}
{% set page_name = "Compras" %}
{% block title %}Compras{% endblock %}

{% block content %}
<div class="fo-layout">
<div class="dynamic-form dynamic-form-card">
  <div class="dynamic-form-toolbar d-flex justify-content-between align-items-center mb-3"></div>
  <div class="fo-status-row d-flex gap-2 mb-2" id="foStatusRow" style="display:none;">
    <div class="fo-status-card sync" id="foSyncBadge">Sincronizado</div>
    <div class="fo-status-card plano" id="foPlanoBadge">Contabilizado</div>
  </div>

  <section class="dynamic-form-body dynamic-form-body-modern">
    <form id="foForm" class="row g-3" autocomplete="off">
      <input type="hidden" id="FOSTAMP" name="FOSTAMP" />
      <input type="hidden" id="MORADA" name="MORADA" />
      <input type="hidden" id="LOCAL" name="LOCAL" />
      <input type="hidden" id="CODPOST" name="CODPOST" />
      <input type="hidden" id="TPSTAMP" name="TPSTAMP" />
      <input type="hidden" id="OLLOCAL" name="OLLOCAL" />
      <input type="hidden" id="SYNC" name="SYNC" />
      <input type="hidden" id="PLANO" name="PLANO" />

      <div class="col-12">
        <div class="row g-2">
        <div class="col-md-3">
          <label class="form-label" for="DOCNOME">Documento <span class="text-danger">*</span></label>
          <select id="DOCNOME" name="DOCNOME" class="form-select" required>
            <option value="">---</option>
          </select>
        </div>
          <div class="col-md-3">
            <label class="form-label" for="ADOC">Numero <span class="text-danger">*</span></label>
            <input type="text" id="ADOC" name="ADOC" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="DATA">Data <span class="text-danger">*</span></label>
            <input type="date" id="DATA" name="DATA" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label" for="PDATA">Vencimento <span class="text-danger">*</span></label>
            <input type="date" id="PDATA" name="PDATA" class="form-control" required>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label" for="NOME">Nome <span class="text-danger">*</span></label>
          <div class="position-relative">
            <input type="text" id="NOME" name="NOME" class="form-control" autocomplete="off" required>
            <div id="nomeSuggestions" class="dropdown-menu w-100" style="max-height:200px; overflow-y:auto;"></div>
          </div>
        </div>
        <div class="col-md-1">
          <label class="form-label" for="NO">No. <span class="text-danger">*</span></label>
          <input type="number" step="1" id="NO" name="NO" class="form-control" readonly required>
        </div>
        <div class="col-md-2">
          <label class="form-label" for="NCONT">NIF</label>
          <input type="text" id="NCONT" name="NCONT" class="form-control" readonly>
        </div>
        <div class="col-md-3">
          <label class="form-label" for="CCUSTO">C. Custo <span class="text-danger">*</span></label>
          <select id="CCUSTO" name="CCUSTO" class="form-select" required>
            <option value="">---</option>
          </select>
        </div>
        </div>
      </div>

      <div class="col-12">
        <div class="fo-totals-row" id="totalsRow">
          <div class="fo-totals-col">
            <label class="form-label" for="TPDESC">Modo Pagamento</label>
            <select id="TPDESC" name="TPDESC" class="form-select">
              <option value="">---</option>
            </select>
          </div>
          <div class="fo-totals-col invisible-slot" id="colabWrapper">
            <label class="form-label" for="COLAB">Colaborador</label>
            <select id="COLAB" name="COLAB" class="form-select">
              <option value="">---</option>
            </select>
          </div>
        <div class="fo-totals-col">
          <label class="form-label" for="ETTILIQ">Base</label>
          <input type="number" step="0.01" id="ETTILIQ" name="ETTILIQ" class="form-control" readonly>
        </div>
        <div class="fo-totals-col">
          <label class="form-label" for="ETTIVA">IVA</label>
          <input type="number" step="0.01" id="ETTIVA" name="ETTIVA" class="form-control" readonly>
        </div>
        <div class="fo-totals-col">
          <label class="form-label" for="ETOTAL">Total</label>
          <input type="number" step="0.01" id="ETOTAL" name="ETOTAL" class="form-control" readonly>
        </div>
        </div>
      </div>
    </form>
  </section>

  <section class="dynamic-form-panels mt-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="d-flex gap-2">
        <button id="btnAddLine" class="btn btn-outline-primary btn-sm">
          <i class="fa fa-plus"></i> Adicionar linha
        </button>
        <button id="btnImportContrato" class="btn btn-outline-secondary btn-sm">
          <i class="fa fa-copy"></i> Importar contrato
        </button>
      </div>
    </div>
  <div class="table-responsive fo-lines">
    <table class="table table-sm table-hover align-middle fo-lines-table fo-lines-compact" id="linesTable">
      <thead>
        <tr>
            <th>Referência</th>
            <th>Designação</th>
            <th>Quant.</th>
            <th>Un.</th>
            <th>Preço</th>
            <th>Total</th>
            <th>IVA</th>
            <th>Incl.</th>
            <th>C. Custo</th>
            <th>Família</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="mt-3 fo-attachments">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0 fw-semibold text-muted">Anexos</h6>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-primary btn-sm" id="btnAddAnexo">
          <i class="fa fa-paperclip"></i> Anexar
        </button>
      </div>
    </div>
    <input type="file" id="inputAnexoFile" style="display:none" />
    <input type="file" id="inputAnexoCamera" accept="image/*" capture="environment" style="display:none" />
    <div id="anexosList" class="d-flex flex-wrap gap-2 small"></div>
  </section>

  <div class="form-actions mt-3">
    <button type="button" id="btnSaveFo" class="btn btn-outline-primary btn-save">
      <i class="fa-solid fa-save"></i>
      <span class="btn-text">Gravar</span>
    </button>
    <button type="button" id="btnCancelFo" class="btn btn-outline-secondary btn-cancel">
      <i class="fa-solid fa-ban"></i>
      <span class="btn-text">Cancelar</span>
    </button>
    <button type="button" id="btnDeleteFo" class="btn btn-outline-secondary btn-delete">
      <i class="fa-solid fa-trash-alt"></i>
      <span class="btn-text">Eliminar</span>
    </button>
  </div>
</div>
</div>

<!-- Modal de pré-visualização de anexo -->
<div class="modal fade" id="anexoPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable anexo-modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="anexoPreviewTitle">Pré-visualização</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body p-0 anexo-modal-body" id="anexoPreviewBody">
        <div class="text-muted small p-3">Selecione um anexo para visualizar.</div>
      </div>
    </div>
  </div>
</div>

<!-- Estilo inline dedicado à grelha de linhas -->
<style>
  .fo-lines {
    background: linear-gradient(145deg, #f8fafc 0%, #eef2f7 100%);
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    padding: 0.75rem;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  }
  .fo-lines-table tbody tr td:nth-child(1),
  .fo-lines-table thead th:nth-child(1) {
    text-align: left !important;
    width: auto !important;
  }
  .fo-lines-table {
    width: 100%;
    font-size: 12px;
    color: #0f172a;
    border-collapse: separate;
    border-spacing: 0 4px;
  }
  .fo-lines-table thead th {
    font-weight: 700;
    color: #1f2937;
    border: none;
    padding: 0.28rem 0.45rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background: transparent;
    font-size: 12px;
  }
  .fo-lines-table tbody tr {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
  }
  .fo-lines-table tbody tr td {
    border: none;
    padding: 0.2rem 0.35rem;
    vertical-align: middle;
    font-size: 12px;
  }
  .fo-lines-table input.form-control,
  .fo-lines-table select.form-select {
    font-size: 12px;
    padding: 0.18rem 0.35rem;
    height: calc(1.5em + 0.35rem);
  }
  .fo-lines-table select.form-select {
    padding-right: 1.5rem;
  }
  .fo-lines-table tbody tr:hover {
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
    border-color: #cbd5e1;
  }
  .fo-lines-table .btn {
    padding: 0.2rem 0.35rem;
    font-size: 0.78rem;
    border-radius: 8px;
  }
  .fo-attachments {
    background: #f8f9fb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 0.75rem;
  }
  .fo-attachments {
    background: #f8f9fb;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 0.75rem;
  }
  /* Numeric fields right-aligned; labels remain default */
  input[type="number"].form-control {
    text-align: right;
  }
  /* Right align numeric columns in grid */
  .fo-lines-table tbody tr td:nth-child(3),
  .fo-lines-table tbody tr td:nth-child(5),
  .fo-lines-table tbody tr td:nth-child(6) {
    text-align: right;
  }
  /* For autocompletes on this page, neutralize global right-align dropdown rule */
  .dropdown-menu.ref-autocomplete,
  #nomeSuggestions.dropdown-menu {
    left: 0 !important;
    right: auto !important;
  }
  .fo-totals-row {
    display: flex !important;
    flex-wrap: nowrap;
    gap: 0.75rem;
    align-items: flex-end;
    width: 100%;
  }
  .fo-totals-col {
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }
  .fo-totals-row .form-control,
  .fo-totals-row .form-select {
    width: 100%;
  }
  .fo-totals-col.invisible-slot {
    visibility: hidden;
  }
  /* Column widths proportional to visible chars */
  .fo-lines-table thead th:nth-child(1),
  .fo-lines-table tbody td:nth-child(1) { width: 10.9%; min-width: 12ch; } /* REF ~20 */
  .fo-lines-table thead th:nth-child(2),
  .fo-lines-table tbody td:nth-child(2) { width: 21.9%; min-width: 22ch; } /* DESIGN ~40 */
  .fo-lines-table thead th:nth-child(3),
  .fo-lines-table tbody td:nth-child(3) { width: 8.2%; min-width: 10ch; }  /* QTT ~15 */
  .fo-lines-table thead th:nth-child(4),
  .fo-lines-table tbody td:nth-child(4) { width: 4.4%; min-width: 7ch; }   /* UN ~8 */
  .fo-lines-table thead th:nth-child(5),
  .fo-lines-table tbody td:nth-child(5) { width: 8.2%; min-width: 10ch; }  /* EPV ~15 */
  .fo-lines-table thead th:nth-child(6),
  .fo-lines-table tbody td:nth-child(6) { width: 8.2%; min-width: 10ch; }  /* TOTAL ~15 */
  .fo-lines-table thead th:nth-child(7),
  .fo-lines-table tbody td:nth-child(7) { width: 6.6%; min-width: 9ch; }   /* IVA ~12 */
  .fo-lines-table thead th:nth-child(8),
  .fo-lines-table tbody td:nth-child(8) { width: 4.4%; min-width: 6ch; }   /* IVAINCL ~8 */
  .fo-lines-table thead th:nth-child(9),
  .fo-lines-table tbody td:nth-child(9) { width: 16.4%; min-width: 18ch; } /* FNCCUSTO ~30 */
  .fo-lines-table thead th:nth-child(10),
  .fo-lines-table tbody td:nth-child(10) { width: 10.9%; min-width: 14ch; }/* FAMILIA ~20 */
  .fo-lines-table thead th:nth-child(11),
  .fo-lines-table tbody td:nth-child(11) { width: 3%; min-width: 6ch; }    /* Ações */
</style>

<!-- Modal Linha FN -->
<div class="modal fade" id="lineModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header border-0 pb-0">
        <div>
          <p class="text-muted text-uppercase small mb-1">Linha FN</p>
          <h5 class="modal-title fw-semibold">Adicionar linha</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body pt-2">
        <div class="alert alert-light border mb-3">
          Preencha os campos da linha e confirme em <strong>Gravar linha</strong>.
        </div>
        <form id="lineForm" class="row g-3">
          <input type="hidden" id="FN_FNSTAMP" name="FNSTAMP" />

          <div class="col-12">
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label" for="FN_REF">REF</label>
                <div class="position-relative">
                  <input type="text" id="FN_REF" name="REF" class="form-control" autocomplete="off" placeholder="Ref. artigo">
                  <div id="refSuggestions" class="dropdown-menu w-100" style="max-height:200px; overflow-y:auto;"></div>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="FN_DESIGN">DESIGN</label>
                <input type="text" id="FN_DESIGN" name="DESIGN" class="form-control" placeholder="Designação">
              </div>
              <div class="col-md-3">
                <label class="form-label" for="FN_FAMILIA">FAMILIA</label>
                <input type="text" id="FN_FAMILIA" name="FAMILIA" class="form-control" placeholder="Família">
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="row g-2">
              <div class="col-md-4">
                <label class="form-label" for="FN_QTT">QTT</label>
                <input type="number" step="0.01" id="FN_QTT" name="QTT" class="form-control" placeholder="Quantidade">
              </div>
              <div class="col-md-2">
                <label class="form-label" for="FN_UNIDADE">UNIDADE</label>
                <input type="text" id="FN_UNIDADE" name="UNIDADE" class="form-control" placeholder="Un.">
              </div>
              <div class="col-md-3">
                <label class="form-label" for="FN_EPV">EPV</label>
                <input type="number" step="0.01" id="FN_EPV" name="EPV" class="form-control" placeholder="Preço">
              </div>
              <div class="col-md-3">
                <label class="form-label" for="FN_ETILIQUIDO">ETILIQUIDO</label>
                <input type="number" step="0.01" id="FN_ETILIQUIDO" name="ETILIQUIDO" class="form-control" readonly>
              </div>
            </div>
          </div>

          <div class="col-12">
            <div class="row g-2">
              <div class="col-md-2">
                <label class="form-label" for="FN_TABIVA">TABIVA</label>
                <select id="FN_TABIVA" name="TABIVA" class="form-select">
                  <option value="">---</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label" for="FN_TAXAIVA">TAXAIVA</label>
                <input type="number" step="0.01" id="FN_TAXAIVA" name="TAXAIVA" class="form-control" readonly>
              </div>
              <div class="col-md-2 d-flex align-items-center">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="FN_IVAINCL" name="IVAINCL" value="1">
                  <label class="form-check-label" for="FN_IVAINCL">IVAINCL</label>
                </div>
              </div>
              <div class="col-md-6">
                <label class="form-label" for="FN_FNCCUSTO">FNCCUSTO</label>
                <select id="FN_FNCCUSTO" name="FNCCUSTO" class="form-select">
                  <option value="">---</option>
                </select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer border-0 pt-0">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="btnSaveLine" class="btn btn-primary">Gravar linha</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Importar Contrato -->
<div class="modal fade" id="contratoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow-lg border-0">
      <div class="modal-header">
        <div>
          <p class="text-muted text-uppercase small mb-1">Contrato</p>
          <h5 class="modal-title fw-semibold">Importar linhas de contrato</h5>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-6">
            <label class="form-label mb-1" for="contratoSearch">Pesquisar</label>
            <input type="text" id="contratoSearch" class="form-control" placeholder="Filtrar por nome, máquina, obra, nº...">
          </div>
          <div class="col-md-6 text-md-end">
            <div id="contratoSupplierInfo" class="small text-muted"></div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle" id="contratoTable">
            <thead>
              <tr>
                <th>Nº</th>
                <th>Documento</th>
                <th>Obra</th>
                <th>Máquina</th>
                <th class="text-end">Total</th>
                <th>Fornecedor</th>
                <th class="text-end"></th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="7" class="text-muted">A carregar...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  window.FO_STAMP = {{ record_stamp|tojson }};
  window.RETURN_TO = "{{ request.args.get('return_to', url_for('generic.view_table', table_name='FO')) }}";
  window.SAVE_OVERLAY_TEXT = "A gravar...";
</script>
<script type="module" src="{{ url_for('static', filename='js/fo_compras_form.js') }}"></script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .fo-lines {
    background: linear-gradient(145deg, #f8fafc 0%, #eef2f7 100%);
    border: 1px solid #e2e8f0;
    border-radius: 14px;
    padding: 0.75rem;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.06);
  }
  .fo-lines-table {
    width: 100%;
    font-size: 12px;
    color: #0f172a;
    border-collapse: separate;
    border-spacing: 0 4px;
  }
  .fo-lines-table thead th {
    font-weight: 700;
    color: #1f2937;
    border: none;
    padding: 0.28rem 0.45rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    background: transparent;
    font-size: 12px;
  }
  .fo-lines-table tbody tr {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.05);
  }
  .fo-lines-table tbody tr td {
    border: none;
    padding: 0.2rem 0.35rem;
    vertical-align: middle;
    font-size: 12px;
  }
  .fo-lines-table tbody tr:hover {
    background: linear-gradient(120deg, #f1f5f9 0%, #e0f2fe 100%);
    border-color: #cbd5e1;
  }
  .fo-lines-table .btn {
    padding: 0.2rem 0.35rem;
    font-size: 0.78rem;
    border-radius: 8px;
  }
  /* Numeric fields right-aligned; labels remain default */
  input[type="number"].form-control {
    text-align: right;
  }
  /* Right align numeric columns in grid */
  .fo-lines-table tbody tr td:nth-child(3),
  .fo-lines-table tbody tr td:nth-child(5),
  .fo-lines-table tbody tr td:nth-child(6) {
    text-align: right;
  }
  /* Compact inputs/selects so they match header spacing and avoid overlap */
  .fo-lines-table tbody input.form-control,
  .fo-lines-table tbody select.form-select {
    font-size: 12px;
    padding: 0.18rem 0.35rem;
    height: calc(1.5em + 0.35rem);
  }
  .fo-lines-table tbody select.form-select {
    padding-right: 1.5rem;
    min-width: 110px;
  }
  /* Compact variant for this grid */
  .fo-lines-compact tbody input.form-control,
  .fo-lines-compact tbody select.form-select {
    font-size: 12px;
    height: calc(1.5em + 0.35rem);
  }
  .fo-lines-compact tbody input.form-control {
    padding: 0.2rem 0.35rem;
  }
  .fo-lines-compact tbody select.form-select {
    padding: 0.2rem 2rem 0.2rem 0.35rem;
  }
  .fo-lines-compact tbody input[data-field="FAMILIA"] {
    pointer-events: auto;
  }
  /* For autocompletes on this page, override the global dropdown alignment */
  .dropdown-menu.ref-autocomplete,
  #nomeSuggestions.dropdown-menu {
    left: 0 !important;
    right: auto !important;
  }
  .anexo-modal-body {
    width: 100%;
    height: calc(90vh - 56px);
    padding: 0;
    display: flex;
  }
  .anexo-modal-body embed,
  .anexo-modal-body object,
  .anexo-modal-body iframe,
  .anexo-modal-body img {
    display: block;
    width: 100%;
    height: 100%;
    border: none;
    flex: 1;
  }
  .fo-totals-row {
    display: flex !important;
    flex-wrap: nowrap;
    gap: 0.75rem;
    align-items: flex-end;
    width: 100%;
  }
  .fo-totals-col {
    flex: 1 1 0;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }
  .fo-totals-row .form-control,
  .fo-totals-row .form-select {
    width: 100%;
  }
  .fo-totals-col.invisible-slot {
    visibility: hidden;
  }
  .fo-status-row {
    align-items: center;
    display: flex !important;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .fo-status-row .fo-status-card {
    padding: 0.5rem 1rem !important;
    border-radius: 10px !important;
    font-size: 0.88rem !important;
    font-weight: 700 !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.4rem !important;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08) !important;
    letter-spacing: 0.01em !important;
    background: #e2e8f0 !important;
    color: #0f172a !important;
    border: 1px solid #cbd5e1 !important;
    min-height: 38px;
  }
  .fo-status-row .fo-status-card.sync {
    background: #0d6efd !important;
    color: #fff !important;
    border-color: #0b5ed7 !important;
  }
  .fo-status-row .fo-status-card.plano {
    background: #198754 !important;
    color: #fff !important;
    border-color: #146c43 !important;
  }
</style>
{% endblock %}
