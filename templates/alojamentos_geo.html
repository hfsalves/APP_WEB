{% extends "base.html" %}

{% block title %}Geolocalização de Alojamentos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<div class="geo-topbar">
  <button id="geoToggleAll" class="btn btn-outline-primary btn-sm" type="button">
    Mostra Todos <span id="geoCount" class="geo-count">(0 no mapa)</span>
  </button>
</div>

<div class="geo-page">
  <div class="geo-left">
    <div class="geo-list-header">
      <input id="geoSearch" class="form-control" placeholder="Pesquisar alojamento..." />
      <div id="geoListStatus" class="geo-status">A carregar...</div>
    </div>
    <div id="geoList" class="geo-list"></div>
  </div>

  <div class="geo-right">
    <div class="geo-right-top">
      <div class="geo-form card">
        <div class="card-body">
          <div class="geo-form-header">
            <div>
              <div id="geoSelectedName" class="geo-selected-name">Seleciona um alojamento</div>
              <div id="geoDirty" class="geo-dirty">Alterações por guardar</div>
            </div>
            <div class="geo-actions">
              <button id="geoLocate" class="btn btn-outline-primary btn-sm" type="button">Localizar no mapa</button>
              <button id="geoReset" class="btn btn-outline-secondary btn-sm" type="button">Repor para BD</button>
              <button id="geoSave" class="btn btn-primary btn-sm" type="button" disabled>Guardar coordenadas</button>
              <button id="geoRouteBtn" class="btn btn-outline-secondary btn-sm" type="button">Percurso</button>
            </div>
          </div>
          <div class="row g-2 mt-2 geo-fields">
            <div class="col-md-6">
              <label class="form-label">Morada</label>
              <div id="geoMorada" class="geo-field-value">—</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Código Postal</label>
              <div id="geoCodpost" class="geo-field-value">—</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Localidade</label>
              <div id="geoLocal" class="geo-field-value">—</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Latitude</label>
              <div id="geoLat" class="geo-field-value">—</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Longitude</label>
              <div id="geoLon" class="geo-field-value">—</div>
            </div>
          </div>
          <div id="geoRouteInfo" class="geo-route-info" style="display:none;"></div>
          <div id="geoAlt" class="geo-alt"></div>
        </div>
      </div>
      <div class="geo-rotas">
        <div class="geo-rotas-title">ROTAS</div>
        <div class="geo-rotas-actions">
          <button id="rotasStart" class="btn btn-primary btn-sm" type="button">Recalcular ROTAS</button>
          <button id="rotasMissing" class="btn btn-outline-secondary btn-sm" type="button">Gerar em falta</button>
          <button id="rotasResume" class="btn btn-outline-primary btn-sm" type="button">Retomar pendentes</button>
          <button id="rotasStop" class="btn btn-outline-secondary btn-sm" type="button" disabled>Parar</button>
        </div>
        <div class="geo-rotas-progress">
          <div class="geo-rotas-bar">
            <div id="rotasProgress" class="geo-rotas-bar-fill" style="width:0%"></div>
          </div>
          <div id="rotasText" class="geo-rotas-text">Idle</div>
          <div id="rotasCounts" class="geo-rotas-counts">0/0 · OK 0 · Erros 0 · Pendentes 0</div>
        </div>
      </div>
    </div>

    <div class="geo-map card">
      <div class="card-body p-0">
        <div id="geoMap"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="geoRouteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Melhor percurso entre locais</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small text-muted">Origem fixa: <strong id="geoRouteFrom">—</strong></div>
        <div class="small text-muted mb-2">Seleciona um ou mais destinos adicionais.</div>
        <div id="geoRouteCards" class="geo-route-cards"></div>
        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" id="geoRouteReturn">
          <label class="form-check-label" for="geoRouteReturn">Volta à origem</label>
        </div>
        <div id="geoRouteLoading" class="geo-route-loading">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span>A calcular...</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="geoRouteApply">OK</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="{{ url_for('static', filename='js/alojamentos_geo.js') }}"></script>
{% endblock %}
