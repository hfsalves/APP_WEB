{% extends "base.html" %}
{% block title %}Faturação{% endblock %}
{% block content %}
<div class="container-fluid py-3">
  <div class="card">
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2 align-items-end mb-3">
        <div>
          <label class="form-label mb-1">Ano</label>
          <input id="ftListAno" class="form-control form-control-sm" type="number" min="2000" max="2100" value="">
        </div>
        <div>
          <label class="form-label mb-1">Mês</label>
          <input id="ftListMes" class="form-control form-control-sm" type="number" min="1" max="12" value="">
        </div>
        <div class="flex-grow-1">
          <label class="form-label mb-1">Pesquisa</label>
          <input id="ftListQ" class="form-control form-control-sm" placeholder="Nome, tipo, série, número...">
        </div>
        <button id="ftListPesquisar" class="btn btn-outline-primary btn-sm">Pesquisar</button>
        <a class="btn btn-primary btn-sm" href="/faturacao/ft/new">Novo Documento</a>
      </div>
      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Data</th>
              <th>Tipo</th>
              <th>Série</th>
              <th>Nº</th>
              <th>Entidade</th>
              <th class="text-end">Líquido</th>
              <th class="text-end">IVA</th>
              <th class="text-end">Total</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="ftListBody">
            <tr><td colspan="9" class="text-muted">A carregar...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<script>
(() => {
  const body = document.getElementById('ftListBody');
  const qEl = document.getElementById('ftListQ');
  const aEl = document.getElementById('ftListAno');
  const mEl = document.getElementById('ftListMes');
  const btn = document.getElementById('ftListPesquisar');
  const fmt = (v) => Number(v || 0).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const dmy = (v) => {
    if (!v) return '';
    const s = String(v).slice(0, 10);
    const p = s.split('-');
    return p.length === 3 ? `${p[2]}/${p[1]}/${p[0]}` : s;
  };
  async function load() {
    body.innerHTML = '<tr><td colspan="9" class="text-muted">A carregar...</td></tr>';
    const qs = new URLSearchParams();
    if ((aEl.value || '').trim()) qs.set('ano', aEl.value.trim());
    if ((mEl.value || '').trim()) qs.set('mes', mEl.value.trim());
    if ((qEl.value || '').trim()) qs.set('q', qEl.value.trim());
    const r = await fetch(`/api/faturacao/ft/list?${qs.toString()}`);
    const data = await r.json().catch(() => []);
    if (!r.ok) {
      body.innerHTML = `<tr><td colspan="9" class="text-danger">Erro ao carregar lista.</td></tr>`;
      return;
    }
    if (!data.length) {
      body.innerHTML = `<tr><td colspan="9" class="text-muted">Sem documentos.</td></tr>`;
      return;
    }
    body.innerHTML = data.map(row => {
      const estado = Number(row.ANULADA || 0) === 1 ? 'Anulada' : (Number(row.ESTADO || 0) === 1 ? 'Emitida' : 'Rascunho');
      return `<tr data-id="${row.FTSTAMP}">
        <td>${dmy(row.FDATA)}</td>
        <td>${row.NMDOC || ''}</td>
        <td>${row.SERIE || ''}</td>
        <td>${Number(row.FNO || 0)}</td>
        <td>${row.NOME || ''}</td>
        <td class="text-end">${fmt(row.ETTILIQ)}</td>
        <td class="text-end">${fmt(row.ETTIVA)}</td>
        <td class="text-end fw-semibold">${fmt(row.ETOTAL)}</td>
        <td>${estado}</td>
      </tr>`;
    }).join('');
    body.querySelectorAll('tr[data-id]').forEach(tr => tr.addEventListener('click', () => {
      const id = tr.getAttribute('data-id');
      if (id) window.location.href = `/faturacao/ft/${encodeURIComponent(id)}`;
    }));
  }
  btn?.addEventListener('click', load);
  qEl?.addEventListener('input', () => { clearTimeout(window.__ftTimer); window.__ftTimer = setTimeout(load, 250); });
  load();
})();
</script>
{% endblock %}
  aEl.value = String(new Date().getFullYear());
